<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Instagram Chat Viewer</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 0;
    }
    header {
        background: #fff;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    #chatContainer {
        max-width: 800px;
        margin: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .message {
        max-width: 70%;
        padding: 8px 12px;
        border-radius: 18px;
        word-wrap: break-word;
        display: inline-block;
    }
    .me {
        align-self: flex-end;
        background: #d1f0ff;
    }
    .them {
        align-self: flex-start;
        background: #fff;
        border: 1px solid #ddd;
    }
    .timestamp {
        font-size: 0.75em;
        color: #888;
        margin-top: 2px;
    }
    img {
        max-width: 200px;
        display: block;
        margin-top: 5px;
        border-radius: 8px;
    }
    .controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
</style>
</head>
<body>

<header>
    <div class="controls">
        <input type="file" id="fileInput" accept=".json">
        <input type="text" id="searchInput" placeholder="Search messages...">
        <input type="date" id="dateFilter">
    </div>
</header>

<div id="chatContainer"></div>

<script>
let allMessages = [];
let myName = "";

// Fix double-encoded emoji from Instagram exports
function fixEmojis(str) {
    try {
        return decodeURIComponent(escape(str));
    } catch {
        return str;
    }
}

// Render chat messages
function renderChat(messages) {
    const container = document.getElementById('chatContainer');
    container.innerHTML = "";

    messages.forEach(msg => {
        if (!msg.content && !msg.photos && !msg.videos) return;

        const div = document.createElement('div');
        div.classList.add('message');

        if (msg.sender_name === myName) {
            div.classList.add('me');
        } else {
            div.classList.add('them');
        }

        // Text
        if (msg.content) {
            const textDiv = document.createElement('div');
            textDiv.textContent = fixEmojis(msg.content);
            div.appendChild(textDiv);
        }

        // Photos
        if (msg.photos) {
            msg.photos.forEach(photo => {
                const link = document.createElement('a');
                link.href = photo.uri;
                link.target = "_blank";
                const img = document.createElement('img');
                img.src = photo.uri;
                link.appendChild(img);
                div.appendChild(link);
            });
        }

        // Videos
        if (msg.videos) {
            msg.videos.forEach(video => {
                const link = document.createElement('a');
                link.href = video.uri;
                link.target = "_blank";
                link.textContent = "ðŸ“¹ Video";
                div.appendChild(link);
            });
        }

        // Timestamp
        const timeDiv = document.createElement('div');
        timeDiv.classList.add('timestamp');
        timeDiv.textContent = new Date(msg.timestamp_ms).toLocaleString();
        div.appendChild(timeDiv);

        container.appendChild(div);
    });
}

// File load
document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(ev) {
        const data = JSON.parse(ev.target.result);
        allMessages = data.messages || [];

        // Set my name from participants (first is usually me)
        if (data.participants && data.participants.length > 0) {
            myName = data.participants[0].name;
        }

        renderChat(allMessages);
    };
    reader.readAsText(file);
});

// Search
document.getElementById('searchInput').addEventListener('input', e => {
    const term = e.target.value.toLowerCase();
    const filtered = allMessages.filter(m => 
        m.content && fixEmojis(m.content).toLowerCase().includes(term)
    );
    renderChat(filtered);
});

// Date filter
document.getElementById('dateFilter').addEventListener('change', e => {
    const selectedDate = e.target.value;
    if (!selectedDate) {
        renderChat(allMessages);
        return;
    }
    const filtered = allMessages.filter(m => {
        const msgDate = new Date(m.timestamp_ms);
        const msgStr = msgDate.toISOString().split('T')[0];
        return msgStr === selectedDate;
    });
    renderChat(filtered);
});
</script>

</body>
</html>
