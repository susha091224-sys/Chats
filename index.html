<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Instagram Chat Viewer</title>
<style>
  :root {
    --bg: #fafafa;
    --fg: #111;
    --muted:#8f8f8f;
    --bubble-me:#3797f0;
    --bubble-them:#efefef;
    --date-bg:#e9e9e9;
    --card:#fff;
  }
  body.dark {
    --bg:#121212;
    --fg:#e0e0e0;
    --muted:#a1a1a6;
    --bubble-me:#0d6efd;       /* brighter blue */
    --bubble-them:#2c2c2e;     /* darker grey */
    --date-bg:#1f1f1f;
    --card:#1a1a1d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    display:flex;flex-direction:column;
  }
  header{
    position:sticky;top:0;z-index:50;background:var(--card);border-bottom:1px solid rgba(0,0,0,.08);
  }
  .topbar{
    display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;
  }
  .profile{display:flex;align-items:center;gap:10px;min-width:0}
  .profile img{width:36px;height:36px;border-radius:50%;object-fit:cover;background:#ddd}
  .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .right-controls button,.right-controls input[type="checkbox"]{cursor:pointer}
  .controls{
    display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px;border-top:1px solid rgba(0,0,0,.06);
    background:var(--card);
  }
  input,button{
    font:inherit;padding:8px 10px;border:1px solid rgba(0,0,0,.15);border-radius:10px;background:transparent;color:inherit;
  }
  input[type="file"]{padding:6px}
  #chat{
    flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;
  }
  #floatingDate{position:sticky;top:86px;display:flex;justify-content:center;z-index:5;pointer-events:none}
  #floatingDate span{background:var(--date-bg);color:#666;padding:4px 10px;border-radius:12px;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  .date-divider{
    align-self:center;background:var(--date-bg);color:#666;font-size:12px;padding:4px 10px;border-radius:12px;margin:12px 0;
  }
  .row{display:flex;flex-direction:column;gap:2px;margin:2px 0}
  .row.me{align-items:flex-end}
  .row.them{align-items:flex-start}
  .bubble{
    max-width:72%;padding:10px 14px;border-radius:18px;word-wrap:break-word;white-space:pre-wrap;color:#000;
    background:var(--bubble-them);
  }
  .row.them .bubble{background:var(--bubble-them);color:#fff0; /* color set below for contrast */}
  .row.them .bubble{color:#fff}
  .row.me .bubble{background:var(--bubble-me);color:#fff;border-bottom-right-radius:6px}
  .row.them .bubble{border-bottom-left-radius:6px}
  .time{font-size:11px;color:var(--muted);opacity:0;margin-top:3px}
  .row.me .time{text-align:right}
  .row.them .time{text-align:left}
  .bubble:hover + .time{opacity:1}
  .group-gap{height:6px}
  a{color:#00376b;text-decoration:none;word-break:break-all}
  a:hover{text-decoration:underline}
  img.media, video.media{max-width:240px;max-height:240px;border-radius:12px;display:block;margin-top:6px;cursor:pointer}
  #lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:100}
  #lightbox .wrap{max-width:92vw;max-height:92vh}
  #lightbox img,#lightbox video{max-width:92vw;max-height:92vh;display:block}
  #lightbox .close{position:absolute;top:12px;right:18px;font-size:28px;color:#fff;cursor:pointer}
  .hidden{display:none}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.15);background:transparent}
</style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="profile">
        <img id="avatar" alt="Profile" />
        <div class="title" id="chatTitle">Instagram Chat</div>
      </div>
      <div class="right-controls" style="display:flex;align-items:center;gap:8px">
        <label class="pill" style="display:flex;align-items:center;gap:6px;padding:6px 10px">
          <input id="themeToggle" type="checkbox" /> <span>Dark</span>
        </label>
      </div>
    </div>
    <div class="controls">
      <input type="file" id="folderPicker" webkitdirectory directory multiple />
      <input type="search" id="searchBox" placeholder="Searchâ€¦" />
      <input type="date" id="startDate" />
      <input type="date" id="endDate" />
      <button id="clearBtn">Clear</button>
      <button id="toggleUserBtn">Toggle User</button>
    </div>
  </header>

  <div id="floatingDate"><span></span></div>
  <div id="chat"></div>

  <div id="lightbox" role="dialog" aria-modal="true">
    <div class="close" id="lightboxClose" title="Close">&times;</div>
    <div class="wrap" id="lightboxContent"></div>
  </div>

<script>
const $ = sel => document.querySelector(sel);
const chatEl = $('#chat');
const floatingDateSpan = $('#floatingDate span');

function decodeWeirdEmoji(str){ try{ return decodeURIComponent(escape(str)); }catch(e){ return str; } }
function ymd(ms){ return new Date(ms).toISOString().slice(0,10); }
function niceTime(ms){ return new Date(ms).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
function linkify(text){
  const urlRe = /(https?:\/\/[^\s)]+)|(www\.[^\s)]+)/gi;
  const frag = document.createDocumentFragment();
  const s = decodeWeirdEmoji(text);
  let last = 0, m;
  while((m = urlRe.exec(s)) !== null){
    const before = s.slice(last, m.index);
    if(before) frag.appendChild(document.createTextNode(before));
    const url = m[0];
    const a = document.createElement('a');
    a.href = url.startsWith('http') ? url : 'https://' + url;
    a.target = '_blank'; a.rel='noopener';
    a.textContent = url;
    frag.appendChild(a);
    last = m.index + url.length;
  }
  const rest = s.slice(last);
  if(rest) frag.appendChild(document.createTextNode(rest));
  return frag;
}

let allMessages = [], renderStart = 0, renderEnd = 0, PAGE = 80;
let meName = "", themName = "", avatarURL = "";
const mediaByName = new Map();

let toggleUser = false;
const toggleBtn = $('#toggleUserBtn');
toggleBtn.addEventListener('click', ()=>{
  toggleUser = !toggleUser;
  renderWindow(true);
});

const themeToggle = $('#themeToggle');
(function initTheme(){
  const t = localStorage.getItem('theme') || 'light';
  if(t==='dark'){ document.body.classList.add('dark'); themeToggle.checked = true; }
  themeToggle.addEventListener('change', ()=>{
    document.body.classList.toggle('dark', themeToggle.checked);
    localStorage.setItem('theme', themeToggle.checked? 'dark':'light');
  });
})();

const lightbox = $('#lightbox'), lightboxContent = $('#lightboxContent'), lightboxClose = $('#lightboxClose');
lightboxClose.addEventListener('click', ()=> lightbox.style.display='none');
lightbox.addEventListener('click', (e)=> { if(e.target===lightbox) lightbox.style.display='none'; });
function openLightbox(src, isVideo){
  lightboxContent.innerHTML='';
  if(isVideo){
    const v=document.createElement('video'); v.src=src; v.controls=true; v.autoplay=true; v.style.maxWidth='92vw'; v.style.maxHeight='92vh';
    lightboxContent.appendChild(v);
  } else {
    const img=document.createElement('img'); img.src=src; img.alt='media'; img.style.maxWidth='92vw'; img.style.maxHeight='92vh';
    lightboxContent.appendChild(img);
  }
  lightbox.style.display='flex';
}

$('#folderPicker').addEventListener('change', async (e)=>{
  resetAll();
  const files = Array.from(e.target.files);
  const jsonFiles = files.filter(f => f.name.endsWith('.json'));
  const mediaFiles = files.filter(f => !f.name.endsWith('.json'));
  mediaFiles.forEach(f => mediaByName.set(f.name, URL.createObjectURL(f)));
  for(const f of jsonFiles){
    const text = await f.text();
    try{
      const data = JSON.parse(text);
      if(data?.participants && !meName) meName = data.participants[0]?.name || meName;
      const msgs = data.messages || [];
      for(const m of msgs){
        if(m.content) m._content = decodeWeirdEmoji(m.content);
        if(m.share?.share_text) m._share_text = decodeWeirdEmoji(m.share.share_text);
        if(Array.isArray(m.photos)) m._photos = m.photos.map(p => mediaByName.get(p.uri.split('/').pop())).filter(Boolean);
        if(Array.isArray(m.videos)) m._videos = m.videos.map(v => mediaByName.get(v.uri.split('/').pop())).filter(Boolean);
        allMessages.push(m);
      }
      if(data?.participants){
        const others = data.participants.filter(p => p.name !== meName);
        if(others[0]) themName = themName || others[0].name;
      }
    }catch(err){ console.warn('Bad JSON:', f.name, err); }
  }
  if(!meName || !themName){
    const counts = new Map();
    for(const m of allMessages){ if(m.sender_name){ counts.set(m.sender_name, (counts.get(m.sender_name)||0)+1); } }
    const sorted = [...counts.entries()].sort((a,b)=>b[1]-a[1]);
    if(sorted.length>=2){ themName = themName || sorted[0][0]; meName = meName || sorted[1][0]; }
    else if(sorted.length===1) meName = meName || sorted[0][0];
  }
  $('#chatTitle').textContent = themName || 'Instagram Chat';
  const avatarFile = [...mediaByName.keys()].find(n => themName && n.toLowerCase().includes(themName.toLowerCase()));
  $('#avatar').src = avatarFile ? mediaByName.get(avatarFile) : 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><circle cx="40" cy="40" r="40" fill="%23ccc"/><circle cx="40" cy="30" r="14" fill="%23eee"/><rect x="16" y="50" width="48" height="22" rx="11" fill="%23eee"/></svg>';
  allMessages.sort((a,b)=>a.timestamp_ms - b.timestamp_ms);
  if(allMessages.length){
    $('#startDate').value = ymd(allMessages[0].timestamp_ms);
    $('#endDate').value = ymd(allMessages[allMessages.length-1].timestamp_ms);
  }
  renderEnd = allMessages.length;
  renderStart = Math.max(0, renderEnd - PAGE);
  renderWindow(true);
  scrollToBottom(true);
  updateFloatingDate();
});

$('#searchBox').addEventListener('input', applyFilters);
$('#startDate').addEventListener('input', applyFilters);
$('#endDate').addEventListener('input', applyFilters);
$('#clearBtn').addEventListener('click', ()=>{
  $('#searchBox').value='';
  if(allMessages.length){
    $('#startDate').value = ymd(allMessages[0].timestamp_ms);
    $('#endDate').value = ymd(allMessages[allMessages.length-1].timestamp_ms);
  } else { $('#startDate').value=''; $('#endDate').value=''; }
  renderEnd = allMessages.length;
  renderStart = Math.max(0, renderEnd - PAGE);
  renderWindow(true);
  scrollToBottom(true);
  updateFloatingDate();
});

function filtersActive(){
  const s = $('#searchBox').value.trim();
  const a = $('#startDate').value;
  const b = $('#endDate').value;
  if(!allMessages.length) return !!s || !!a || !!b;
  const fullA = ymd(allMessages[0].timestamp_ms);
  const fullB = ymd(allMessages[allMessages.length-1].timestamp_ms);
  return !!s || (a && a!==fullA) || (b && b!==fullB);
}

function applyFilters(){
  const s = $('#searchBox').value.trim().toLowerCase();
  const a = $('#startDate').value;
  const b = $('#endDate').value;
  if(!filtersActive()){
    renderEnd = allMessages.length;
    renderStart = Math.max(0, renderEnd - PAGE);
    renderWindow(true);
    scrollToBottom(true);
    return;
  }
  const from = a ? new Date(a+'T00:00:00').getTime() : -Infinity;
  const to = b ? new Date(b+'T23:59:59.999').getTime() : Infinity;
  const filtered = allMessages.filter(m=>{
    const t=m.timestamp_ms;
    if(t<from || t>to) return false;
    if(!s) return true;
    const blob = (m._content||"") + " " + (m._share_text||"") + " " + (m.share?.link||"");
    return blob.toLowerCase().includes(s);
  });
  renderList(filtered, true);
  scrollToTop();
}

function resetAll(){
  chatEl.innerHTML=''; floatingDateSpan.textContent=''; allMessages=[];
  renderStart=renderEnd=0; meName=themName=''; mediaByName.clear();
  $('#chatTitle').textContent='Instagram Chat'; $('#avatar').src='';
}

function renderWindow(replace){
  const slice = allMessages.slice(renderStart, renderEnd);
  renderList(slice, replace);
}

function renderList(list, replace){
  if(replace) chatEl.innerHTML='';
  const frag = document.createDocumentFragment();
  let lastDay=null, prevSender=null;
  for(const m of list){
    const day = ymd(m.timestamp_ms);
    if(day!==lastDay){
      const divider=document.createElement('div'); divider.className='date-divider';
      divider.setAttribute('data-date', day); divider.textContent = new Date(day).toDateString();
      frag.appendChild(divider); lastDay=day; prevSender=null;
    }
    let isMe = (meName && m.sender_name && m.sender_name.trim().toLowerCase()===meName.trim().toLowerCase());
    if(toggleUser) isMe = !isMe;
    const row=document.createElement('div'); row.className='row '+(isMe?'me':'them');
    if(prevSender!==null && prevSender!==isMe){ const gap=document.createElement('div'); gap.className='group-gap'; frag.appendChild(gap);}
    prevSender=isMe;
    const bubble=document.createElement('div'); bubble.className='bubble';
    if(m._content) bubble.appendChild(linkify(m._content));
    if(m._share_text){ if(m._content) bubble.appendChild(document.createElement('br')); bubble.appendChild(linkify(m._share_text)); }
    if(m.share?.link){ const link=document.createElement('a'); link.href=m.share.link; link.target='_blank'; link.rel='noopener'; link.textContent=m.share.link; bubble.appendChild(document.createElement('br')); bubble.appendChild(link); }
    if(m._photos){ m._photos.forEach(src=>{ const img=document.createElement('img'); img.className='media'; img.src=src; img.addEventListener('click',()=>openLightbox(src,false)); bubble.appendChild(img); }); }
    if(m._videos){ m._videos.forEach(src=>{ const v=document.createElement('video'); v.className='media'; v.src=src; v.controls=true; v.addEventListener('click',()=>openLightbox(src,true)); bubble.appendChild(v); }); }
    const t = document.createElement('div'); t.className='time'; t.textContent = niceTime(m.timestamp_ms);
    row.appendChild(bubble); row.appendChild(t); frag.appendChild(row);
  }
  chatEl.appendChild(frag); updateFloatingDate();
}

function scrollToBottom(smooth){ chatEl.scrollTo({top: chatEl.scrollHeight, behavior: smooth?'smooth':'auto'}); }
function scrollToTop(){ chatEl.scrollTo({top:0, behavior:'auto'}); }

chatEl.addEventListener('scroll', ()=>{
  updateFloatingDate();
  if(filtersActive()) return;
  if(chatEl.scrollTop < 40 && renderStart > 0){
    const priorHeight = chatEl.scrollHeight;
    const newStart = Math.max(0, renderStart - PAGE);
    const slice = allMessages.slice(newStart, renderStart);
    renderList(slice, false);
    renderStart=newStart;
    chatEl.scrollTop += chatEl.scrollHeight - priorHeight;
  }
});

function updateFloatingDate(){
  const rows = [...chatEl.querySelectorAll('.row,.date-divider')];
  const top = chatEl.scrollTop + 60;
  let current = null;
  for(const r of rows){
    const rTop = r.offsetTop;
    if(rTop>top) break;
    if(r.classList.contains('date-divider')) current = r.getAttribute('data-date');
  }
  floatingDateSpan.textContent = current || '';
}
</script>
</body>
</html>
