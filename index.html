<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Instagram Chat Viewer</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 0;
    }
    header {
        padding: 10px;
        background: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    header input {
        margin-right: 10px;
    }
    #chat {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .message {
        max-width: 60%;
        padding: 10px;
        border-radius: 12px;
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    .me {
        background: #dcf8c6;
        align-self: flex-end;
    }
    .them {
        background: #fff;
        align-self: flex-start;
    }
    img, video {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 5px;
    }
    a {
        color: #1877f2;
        text-decoration: none;
    }
</style>
</head>
<body>

<header>
    <div>
        <input type="file" id="fileInput" accept=".json">
        <input type="date" id="dateFilter">
        <input type="text" id="searchBox" placeholder="Search messages">
    </div>
</header>

<div id="chat"></div>

<script>
function fixEmojis(str) {
    try {
        return decodeURIComponent(escape(str));
    } catch (e) {
        return str;
    }
}

let allMessages = [];

document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
        const data = JSON.parse(event.target.result);
        // Instagram export can have messages under data.messages or top-level
        allMessages = data.messages || data;
        renderChat(allMessages);
    };
    reader.readAsText(file);
});

document.getElementById('dateFilter').addEventListener('change', applyFilters);
document.getElementById('searchBox').addEventListener('input', applyFilters);

function applyFilters() {
    const dateValue = document.getElementById('dateFilter').value;
    const searchValue = document.getElementById('searchBox').value.toLowerCase();
    
    let filtered = allMessages;

    if (dateValue) {
        const filterTime = new Date(dateValue).setHours(0,0,0,0);
        filtered = filtered.filter(m => {
            const msgDate = new Date(m.timestamp_ms).setHours(0,0,0,0);
            return msgDate === filterTime;
        });
    }

    if (searchValue) {
        filtered = filtered.filter(m => {
            const textParts = [];
            if (m.content) textParts.push(fixEmojis(m.content));
            if (m.share?.share_text) textParts.push(fixEmojis(m.share.share_text));
            return textParts.join(" ").toLowerCase().includes(searchValue);
        });
    }

    renderChat(filtered);
}

function renderChat(messages) {
    const chat = document.getElementById('chat');
    chat.innerHTML = '';
    messages.sort((a, b) => a.timestamp_ms - b.timestamp_ms);

    messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message ' + (msg.sender_name.toLowerCase() === 'sudharsan' ? 'me' : 'them');

        // Text content
        if (msg.content) {
            const textDiv = document.createElement('div');
            textDiv.textContent = fixEmojis(msg.content);
            div.appendChild(textDiv);
        }

        // Photos
        if (msg.photos) {
            msg.photos.forEach(photo => {
                const img = document.createElement('img');
                img.src = photo.uri;
                div.appendChild(img);
            });
        }

        // Videos
        if (msg.videos) {
            msg.videos.forEach(video => {
                const vid = document.createElement('video');
                vid.src = video.uri;
                vid.controls = true;
                div.appendChild(vid);
            });
        }

        // Link shares
        if (msg.share) {
            if (msg.share.share_text) {
                const shareTextDiv = document.createElement('div');
                shareTextDiv.textContent = fixEmojis(msg.share.share_text);
                div.appendChild(shareTextDiv);
            }
            if (msg.share.link) {
                const linkDiv = document.createElement('a');
                linkDiv.href = msg.share.link;
                linkDiv.target = "_blank";
                linkDiv.textContent = "ðŸ”— Open Link";
                div.appendChild(linkDiv);
            }
            if (msg.share.original_content_owner) {
                const ownerDiv = document.createElement('div');
                ownerDiv.style.fontSize = "0.8em";
                ownerDiv.style.color = "#666";
                ownerDiv.textContent = "Owner: " + msg.share.original_content_owner;
                div.appendChild(ownerDiv);
            }
        }

        chat.appendChild(div);
    });
}
</script>

</body>
</html>
