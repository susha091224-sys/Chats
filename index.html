<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Instagram Chat Viewer</title>
<style>
  :root{
    --me:#3797f0;        /* IG DM blue */
    --them:#efefef;      /* IG DM gray */
    --bg:#fafafa;
    --text:#111;
    --muted:#8f8f8f;
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    display:flex;flex-direction:column;
  }
  header{
    background:#fff;border-bottom:1px solid #e5e5e5;
    padding:8px 10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;position:sticky;top:0;z-index:5;
  }
  header input, header button{
    font:inherit;padding:8px 10px;border:1px solid #ddd;border-radius:10px;background:#fff;
  }
  #nameInput{width:180px}
  #chat{
    flex:1;overflow-y:auto;position:relative;padding:12px 12px 30px;
    display:flex;flex-direction:column; /* newest at bottom via scroll-to-end */
  }
  .date-divider{
    align-self:center;color:var(--muted);font-size:12px;
    background:#e9e9e9;border-radius:12px;padding:4px 10px;margin:14px 0;
  }
  .bubble{
    max-width:72%;padding:10px 14px;border-radius:var(--radius);
    word-wrap:break-word;white-space:pre-wrap;position:relative;margin:2px 0;
  }
  .me{align-self:flex-end;background:var(--me);color:#fff;border-bottom-right-radius:6px;}
  .them{align-self:flex-start;background:var(--them);color:#000;border-bottom-left-radius:6px;}
  .time{
    font-size:11px;color:#9b9b9b;opacity:0;transition:opacity .15s ease;
    margin-top:3px;
  }
  .me .time{ text-align:right; }
  .them .time{ text-align:left; }
  .bubble:hover .time{opacity:1}
  img, video{max-width:240px;max-height:240px;border-radius:12px;display:block;margin-top:6px}
  a{color:#00376b;text-decoration:none;word-break:break-all}
  a:hover{text-decoration:underline}
  mark{background:#ffe38e;padding:0 2px;border-radius:2px}
  /* Floating date at top while scrolling */
  #floatingDate{
    position:sticky;top:50px; /* below the header */
    z-index:4;display:flex;justify-content:center;pointer-events:none;
  }
  #floatingDate span{
    background:#e9e9e9;color:#666;font-size:12px;padding:4px 10px;border-radius:12px;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
  }
</style>
</head>
<body>
  <header>
    <input type="file" id="folderPicker" webkitdirectory directory multiple />
    <input type="text" id="nameInput" placeholder="Your name (right side)" />
    <input type="date" id="dateFilter" />
    <input type="text" id="searchInput" placeholder="Searchâ€¦" />
    <button id="clearBtn">Clear</button>
  </header>

  <div id="floatingDate" aria-hidden="true"><span></span></div>
  <div id="chat"></div>

<script>
/* ---------- Helpers ---------- */

/* Robust emoji fix for IG exports that look like: \u00f0\u009f\u0098\u0082 */
function fixEmojis(str){
  if(!str) return "";
  try{
    // If it contains \u00xx bytes (already decoded to 0x00-0xFF), map 0x00..0xFF to %xx and decode as UTF-8
    // escape() turns each 0x00..0xFF into %xx; decodeURIComponent reads those as UTF-8 bytes.
    const repaired = decodeURIComponent(escape(str));
    return repaired;
  }catch{ return str; }
}

/* Simple URL linker that keeps text nodes emoji-safe and adds <a> only for links */
const urlRe = /(https?:\/\/[^\s)]+)|(www\.[^\s)]+)/gi;
function linkifyAndHighlight(text, query=""){
  const frag = document.createDocumentFragment();
  const safe = fixEmojis(text);
  let last = 0;
  const pushText = (t, highlight=false)=>{
    if(!t) return;
    if(!highlight){ frag.appendChild(document.createTextNode(t)); return; }
    const mark = document.createElement('mark'); mark.textContent = t; frag.appendChild(mark);
  };
  // First split into link vs non-link
  let m;
  while((m = urlRe.exec(safe)) !== null){
    const url = m[0];
    const before = safe.slice(last, m.index);
    appendWithHighlight(before, query);
    const a = document.createElement('a');
    a.href = url.startsWith('http') ? url : ('https://' + url);
    a.target = "_blank"; a.rel = "noopener";
    a.textContent = url;
    frag.appendChild(a);
    last = m.index + url.length;
  }
  appendWithHighlight(safe.slice(last), query);
  return frag;

  function appendWithHighlight(chunk, q){
    if(!q){ frag.appendChild(document.createTextNode(chunk)); return; }
    const low = chunk.toLowerCase();
    const needle = q.toLowerCase();
    if(!needle.trim()){ frag.appendChild(document.createTextNode(chunk)); return; }
    let i = 0, idx;
    while((idx = low.indexOf(needle, i)) !== -1){
      const pre = chunk.slice(i, idx);
      const hit = chunk.slice(idx, idx+needle.length);
      if(pre) frag.appendChild(document.createTextNode(pre));
      if(hit) pushText(hit, true);
      i = idx + needle.length;
    }
    const rest = chunk.slice(i);
    if(rest) frag.appendChild(document.createTextNode(rest));
  }
}

/* Date utilities */
function ymd(ms){ return new Date(ms).toISOString().slice(0,10); }
function niceDate(ms){ return new Date(ms).toDateString(); }
function niceTime(ms){ return new Date(ms).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

/* ---------- State ---------- */
let allMessages = [];     // fully normalized & sorted ascending
let renderStart = 0;      // index of first rendered message
let renderEnd = 0;        // index after last rendered (exclusive)
const pageSize = 80;
let mediaMap = new Map(); // filename -> objectURL
let meName = "";
const chat = document.getElementById('chat');
const floatingDateSpan = document.querySelector('#floatingDate span');

/* ---------- Load Folder ---------- */
document.getElementById('folderPicker').addEventListener('change', async (e)=>{
  resetAll();
  const files = Array.from(e.target.files);
  const jsons = files.filter(f => f.name.endsWith('.json'));
  const media = files.filter(f => !f.name.endsWith('.json'));

  // Build filename -> objectURL map (O(1) lookup)
  media.forEach(f => mediaMap.set(f.name, URL.createObjectURL(f)));

  // Merge messages
  for(const f of jsons){
    const text = await f.text();
    const data = JSON.parse(text);
    if(!meName && data.participants && data.participants.length){
      // default guess: first participant is you (editable in UI)
      meName = data.participants[0].name;
      document.getElementById('nameInput').value = meName;
    }
    const msgs = data.messages || data || [];
    for(const m of msgs){
      // Normalize attachments to object URLs if available
      if(Array.isArray(m.photos)){
        m._photos = m.photos
          .map(p => mediaMap.get((p.uri||"").split('/').pop()))
          .filter(Boolean);
      }
      if(Array.isArray(m.videos)){
        m._videos = m.videos
          .map(v => mediaMap.get((v.uri||"").split('/').pop()))
          .filter(Boolean);
      }
      // Pre-store decoded text for speed
      if(m.content) m._content = fixEmojis(m.content);
      if(m.share && m.share.share_text) m._share_text = fixEmojis(m.share.share_text);
      allMessages.push(m);
    }
  }
  // Sort strictly by timestamp
  allMessages.sort((a,b)=>a.timestamp_ms - b.timestamp_ms);

  // Initial window = last page
  renderEnd = allMessages.length;
  renderStart = Math.max(0, renderEnd - pageSize);
  renderInitial();
  scrollToBottom();

  // Update floating date immediately
  updateFloatingDate();
});

/* ---------- Controls ---------- */
document.getElementById('nameInput').addEventListener('input', (e)=>{
  meName = e.target.value.trim();
  rerenderCurrentWindow();
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('dateFilter').value = "";
  document.getElementById('searchInput').value = "";
  rerenderCurrentWindow();
});

document.getElementById('dateFilter').addEventListener('input', applyFilters);
document.getElementById('searchInput').addEventListener('input', applyFilters);

/* When filters are active, render only matches and pause infinite scroll */
function applyFilters(){
  const dateVal = document.getElementById('dateFilter').value;
  const q = document.getElementById('searchInput').value.trim().toLowerCase();

  if(!dateVal && !q){
    // back to windowed infinite scroll
    rerenderCurrentWindow();
    scrollToBottomIfNearEnd();
    return;
  }

  // Filtered render (no paging for now)
  const filtered = allMessages.filter(m=>{
    if(dateVal && ymd(m.timestamp_ms)!==dateVal) return false;
    if(q){
      const blob = (m._content||"") + " " + (m._share_text||"") + " " + (m.share?.link||"");
      if(!blob.toLowerCase().includes(q)) return false;
    }
    return true;
  });
  renderList(filtered, true, q); // full replace
}

/* ---------- Rendering ---------- */
function resetAll(){
  chat.innerHTML = "";
  allMessages = [];
  mediaMap = new Map();
  renderStart = renderEnd = 0;
  floatingDateSpan.textContent = "";
}

function renderInitial(){
  chat.innerHTML = "";
  const slice = allMessages.slice(renderStart, renderEnd);
  renderList(slice, true);
}

function rerenderCurrentWindow(){
  const slice = allMessages.slice(renderStart, renderEnd);
  renderList(slice, true);
}

function renderList(list, replace=false, highlightQuery=""){
  if(replace) chat.innerHTML = "";

  const frag = document.createDocumentFragment();
  let lastDate = null;

  for(const m of list){
    const day = ymd(m.timestamp_ms);
    if(day !== lastDate){
      // avoid duplicate divider if last child already has this date
      const lastChild = frag.lastElementChild || chat.lastElementChild;
      const lastIsSame =
        lastChild && lastChild.classList && lastChild.classList.contains('date-divider') &&
        lastChild.getAttribute('data-date') === day;
      if(!lastIsSame){
        const divider = document.createElement('div');
        divider.className = 'date-divider';
        divider.setAttribute('data-date', day);
        divider.textContent = niceDate(m.timestamp_ms);
        frag.appendChild(divider);
      }
      lastDate = day;
    }

    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + ((meName && m.sender_name && m.sender_name.trim().toLowerCase()===meName.trim().toLowerCase()) ? 'me':'them');
    bubble.setAttribute('data-date', day);

    // text content (with linkify + highlight)
    if(m._content){
      bubble.appendChild(linkifyAndHighlight(m._content, highlightQuery));
    }

    // share text + link
    if(m._share_text){
      if(m._content) bubble.appendChild(document.createElement('br'));
      bubble.appendChild(linkifyAndHighlight(m._share_text, highlightQuery));
    }
    if(m.share && m.share.link){
      const a = document.createElement('a');
      a.href = m.share.link; a.target="_blank"; a.rel="noopener";
      a.textContent = m.share.link;
      bubble.appendChild(document.createElement('br'));
      bubble.appendChild(a);
    }

    // photos
    if(m._photos && m._photos.length){
      m._photos.forEach(src=>{
        const img = document.createElement('img'); img.src = src;
        img.loading="lazy"; img.decoding="async";
        img.addEventListener('click',()=>window.open(src,'_blank'));
        bubble.appendChild(img);
      });
    }

    // videos
    if(m._videos && m._videos.length){
      m._videos.forEach(src=>{
        const v = document.createElement('video'); v.src = src; v.controls = true;
        v.preload = "metadata";
        bubble.appendChild(v);
      });
    }

    const t = document.createElement('div');
    t.className = 'time';
    t.textContent = niceTime(m.timestamp_ms);
    bubble.appendChild(t);

    frag.appendChild(bubble);
  }
  chat.appendChild(frag);
  updateFloatingDate();
}

/* Infinite scroll: prepend older messages when near top */
chat.addEventListener('scroll', ()=>{
  updateFloatingDate();

  // If filters active, skip infinite scroll
  if(document.getElementById('dateFilter').value || document.getElementById('searchInput').value.trim()){
    return;
  }

  if(chat.scrollTop < 60 && renderStart > 0){
    const prevHeight = chat.scrollHeight;
    const newStart = Math.max(0, renderStart - pageSize);
    const slice = allMessages.slice(newStart, renderStart);
    renderStart = newStart;

    // Prepend without wiping, but maintain scroll position
    const beforeTopOffset = chat.scrollHeight;
    const frag = document.createDocumentFragment();
    // build with consistent date dividers
    let lastDate = null;
    const firstExisting = chat.firstElementChild;
    const firstExistingDate = firstExisting && firstExisting.getAttribute && firstExisting.getAttribute('data-date');

    for(const m of slice){
      const day = ymd(m.timestamp_ms);
      if(day !== lastDate){
        // avoid duplicate with first existing divider
        const addDivider = !(firstExisting && firstExisting.classList.contains('date-divider') && firstExistingDate===day && lastDate===null);
        if(addDivider){
          const divider = document.createElement('div');
          divider.className='date-divider';
          divider.setAttribute('data-date', day);
          divider.textContent = niceDate(m.timestamp_ms);
          frag.appendChild(divider);
        }
        lastDate = day;
      }
      const dummy = document.createElement('div');
      // reuse renderer by temporary list
      renderList([m], false);
      // (we already appended to chat; we need a safe prepend path)
      // To keep it simple: remove what renderList added at end and move to frag
    }
    // The snippet above complicates; simpler: render slice into a hidden container:
  }
});

/* Because the prepend path above got complex, implement a simpler helper */
function prependMessages(list){
  const frag = document.createDocumentFragment();
  let lastDate = null;
  const firstExisting = chat.firstElementChild;
  const firstExistingDate = firstExisting && firstExisting.getAttribute && firstExisting.getAttribute('data-date');

  for(const m of list){
    const day = ymd(m.timestamp_ms);
    if(day !== lastDate){
      const addDivider = !(firstExisting && firstExisting.classList.contains('date-divider') && firstExistingDate===day && lastDate===null);
      if(addDivider){
        const divider = document.createElement('div');
        divider.className='date-divider';
        divider.setAttribute('data-date', day);
        divider.textContent = niceDate(m.timestamp_ms);
        frag.appendChild(divider);
      }
      lastDate = day;
    }
    // create bubble node
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + ((meName && m.sender_name && m.sender_name.trim().toLowerCase()===meName.trim().toLowerCase()) ? 'me':'them');
    bubble.setAttribute('data-date', day);
    if(m._content){ bubble.appendChild(linkifyAndHighlight(m._content)); }
    if(m._share_text){
      if(m._content) bubble.appendChild(document.createElement('br'));
      bubble.appendChild(linkifyAndHighlight(m._share_text));
    }
    if(m.share && m.share.link){
      const a = document.createElement('a'); a.href=m.share.link; a.target="_blank"; a.rel="noopener"; a.textContent=m.share.link;
      bubble.appendChild(document.createElement('br')); bubble.appendChild(a);
    }
    if(m._photos){ m._photos.forEach(src=>{ const img=document.createElement('img'); img.src=src; img.loading="lazy"; img.decoding="async"; img.addEventListener('click',()=>window.open(src,'_blank')); bubble.appendChild(img); }); }
    if(m._videos){ m._videos.forEach(src=>{ const v=document.createElement('video'); v.src=src; v.controls=true; v.preload="metadata"; bubble.appendChild(v); }); }
    const t=document.createElement('div'); t.className='time'; t.textContent=niceTime(m.timestamp_ms); bubble.appendChild(t);
    frag.appendChild(bubble);
  }
  const prevHeight = chat.scrollHeight;
  chat.insertBefore(frag, chat.firstChild);
  // keep viewport anchored
  const newHeight = chat.scrollHeight;
  chat.scrollTop += (newHeight - prevHeight);
  updateFloatingDate();
}

/* Rewire the infinite scroll now that prependMessages exists */
chat.addEventListener('scroll', ()=>{
  updateFloatingDate();
  if(document.getElementById('dateFilter').value || document.getElementById('searchInput').value.trim()){ return; }
  if(chat.scrollTop < 60 && renderStart > 0){
    const newStart = Math.max(0, renderStart - pageSize);
    const slice = allMessages.slice(newStart, renderStart);
    renderStart = newStart;
    prependMessages(slice);
  }
});

/* Floating date updater: picks the last divider whose top is above the viewport */
function updateFloatingDate(){
  const top = chat.scrollTop;
  const nodes = chat.querySelectorAll('.date-divider');
  let current = "";
  for(const node of nodes){
    if(node.offsetTop - top <= 10){ current = node.getAttribute('data-date'); }
    else break;
  }
  floatingDateSpan.textContent = current ? new Date(current).toDateString() : "";
}

/* Utilities */
function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }
function scrollToBottomIfNearEnd(){
  const nearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 200;
  if(nearBottom) scrollToBottom();
}
</script>
</body>
</html>
